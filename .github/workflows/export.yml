name: Export Game

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag for this build (e.g., v1.2.3)'
        required: false
        default: 'manual-build'

jobs:
  export:
    name: Export Game
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Extract Godot version from project.godot
        id: version
        run: |
          # Capture major.minor or major.minor.patch from project.godot
          VERSION=$(grep 'config/features=' project.godot | grep -oP '"\K[0-9]+\.[0-9]+(?:\.[0-9]+)?(?=")')
          if [ -z "$VERSION" ]; then
            echo "Error: Godot version not found in config/features"
            exit 1
          fi
          # If only major.minor (e.g. 4.5) was found, normalize to patch .0 (-> 4.5.0)
          if [[ "$VERSION" =~ ^[0-9]+\.[0-9]+$ ]]; then
            VERSION="$VERSION.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted Godot version: $VERSION"

      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v1
        with:
          version: ${{ steps.version.outputs.version }}
          use-dotnet: false

      - name: Verify Godot installation
        run: godot --version

      - name: Import assets
        run: |
          mkdir -p .godot/imported
          godot --headless --editor --quit || true

      - name: Export for Web
        run: |
          mkdir -p build/web
          godot --headless --export-release "Web" build/web/index.html

      - name: Export for Windows
        run: |
          mkdir -p build/windows
          godot --headless --export-release "Windows Desktop" build/windows/game.exe

      - name: Upload Web build
        uses: actions/upload-artifact@v4
        with:
          name: web-build-v${{ steps.version.outputs.version }}
          path: build/web/
          if-no-files-found: warn

      - name: Upload Windows build
        uses: actions/upload-artifact@v4
        with:
          name: windows-build-v${{ steps.version.outputs.version }}
          path: build/windows/
          if-no-files-found: warn
